<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快算盘 | ZenFlow - SaaS 旗舰版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { corePlugins: { preflight: true } }</script>
    <script src="https://unpkg.com/pinyin-pro@3.13.2/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #2563eb; --sidebar-bg: #0f172a; }
        body { font-family: "Inter", "Microsoft YaHei", sans-serif; background-color: #f8fafc; }
        .zen-sidebar { background: linear-gradient(180deg, var(--sidebar-bg) 0%, #1e1b4b 100%); }
        ::-webkit-scrollbar { width: 6px; height: 6px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .clean-input { width: 100%; padding: 8px 10px; font-size: 0.85rem; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; transition: all 0.2s; color: #334155; }
        .clean-input:hover { border-color: #cbd5e1; }
        .clean-input:focus { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1); }
        .nav-item.active { background-color: rgba(255,255,255,0.1); color: #fff; border-left: 3px solid #fbbf24; }
        .tool-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 700; background-color: white; border: 1px solid #e2e8f0; color: #475569; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .tool-btn:hover { background-color: #f8fafc; border-color: #cbd5e1; color: #2563eb; }
        .market-table th { background-color: #f8fafc; color: #64748b; font-size: 0.75rem; font-weight: 700; padding: 0.8rem; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .market-table td { border-bottom: 1px solid #f1f5f9; padding: 0.8rem; font-size: 0.85rem; font-weight: 700; color: #334155; text-align: center; }
        @media print { 
            @page { margin: 5mm; size: A4 portrait; } 
            body > *:not(#preview-modal) { display: none !important; } 
            body, html { height: auto !important; overflow: visible !important; background: white !important; } 
            #preview-modal { position: absolute !important; top: 0; left: 0; width: 100%; height: auto !important; background: white; z-index: 9999; display: block !important; overflow: visible !important; transform: none !important; } 
            .receipt-item { page-break-inside: avoid; margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 20px; } 
            .no-print { display: none !important; } 
            .seal-corp, .seal-person { border-color: red !important; color: red !important; } 
        }
        .contract-font { font-family: "SimSun", "Songti SC", serif; } 
        .contract-num { font-family: "Arial", "Helvetica", sans-serif; font-weight: bold; }
        .seal-corp { width: 120px; height: 80px; border: 3px solid rgba(255, 0, 0, 0.8); border-radius: 50% / 50%; color: rgba(255, 0, 0, 0.8); position: relative; text-align: center; font-family: "SimSun"; font-weight: bold; display: flex; flex-direction: column; justify-content: center; transform: rotate(-5deg); pointer-events: none; }
        .seal-corp-name { font-size: 10px; padding: 0 10px; } 
        .seal-corp-type { font-size: 14px; border-top: 1px solid rgba(255, 0, 0, 0.6); margin-top: 2px; }
        .seal-person { width: 45px; height: 45px; border: 3px solid rgba(255, 0, 0, 0.8); color: rgba(255, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; font-size: 16px; font-family: "SimSun"; font-weight: bold; line-height: 1.1; padding: 2px; transform: rotate(-10deg); pointer-events: none; }
        .term-title { font-weight: bold; margin-top: 8px; margin-bottom: 2px; font-size: 11px; }
        .term-content { text-indent: 0; text-align: justify; line-height: 1.4; color: #333; font-size: 10px; }
        .bank-info-box { background-color: #f9fafb; padding: 5px; border: 1px dashed #cbd5e1; margin: 5px 0; font-family: "Courier New", monospace; }
        .contract-table th, .contract-table td { text-align: center !important; vertical-align: middle; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden text-slate-800 font-sans">
    <aside class="zen-sidebar w-64 flex-shrink-0 flex flex-col transition-all duration-300 transform fixed md:relative z-50 h-full hidden md:flex" id="sidebar">
        <div class="h-16 flex items-center px-6 border-b border-white/10"><div class="w-8 h-8 bg-yellow-500 rounded flex items-center justify-center text-blue-900 font-bold mr-3"><i class="fas fa-calculator"></i></div><span class="text-white text-lg font-bold tracking-wide">ZenFlow <span class="text-xs text-yellow-400 opacity-80">SaaS</span></span></div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <a href="#" onclick="switchPage('workbench', this)" class="nav-item active flex items-center px-6 py-3 text-slate-300 hover:bg-white/5 hover:text-white transition"><i class="fas fa-home w-6 text-center mr-2"></i> <span class="font-medium text-sm">工作台</span></a>
            <a href="#" onclick="switchPage('documents', this)" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:bg-white/5 hover:text-white transition"><i class="fas fa-file-invoice w-6 text-center mr-2"></i> <span class="font-medium text-sm">单据中心</span></a>
            <a href="#" onclick="switchPage('tools', this)" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:bg-white/5 hover:text-white transition"><i class="fas fa-toolbox w-6 text-center mr-2"></i> <span class="font-medium text-sm">转换工厂</span></a>
            <a href="#" onclick="switchPage('settings', this)" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:bg-white/5 hover:text-white transition"><i class="fas fa-cog w-6 text-center mr-2"></i> <span class="font-medium text-sm">配置中心</span></a>
        </nav>
        <div class="p-4 border-t border-white/10"><div class="flex items-center gap-3 text-white/80 cursor-pointer hover:text-white transition" onclick="toggleUserMenu(event)"><div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold text-xs" id="sidebar-avatar">U</div><div class="flex-1 min-w-0"><p class="text-sm font-bold truncate" id="sidebar-username">User</p><p class="text-[10px] text-slate-400">在线</p></div><i class="fas fa-sign-out-alt hover:text-red-400" onclick="doLogout()"></i></div></div>
    </aside>
    <div class="flex-1 flex flex-col h-full relative">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 flex-shrink-0"><button onclick="toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-700"><i class="fas fa-bars text-xl"></i></button><h2 class="text-lg font-bold text-slate-700" id="page-title">工作台</h2><div class="flex items-center gap-4"><button onclick="window.location.reload()" class="text-slate-400 hover:text-blue-600 transition" title="刷新"><i class="fas fa-sync-alt"></i></button></div></header>
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative" id="main-content">
            <div id="page-workbench" class="space-y-6 max-w-6xl mx-auto">
                <div class="bg-white p-2 rounded-full shadow-sm border border-slate-200 flex items-center focus-within:ring-2 ring-blue-100 transition-all max-w-2xl mx-auto"><select id="engine-select" class="bg-transparent border-none text-xs font-bold text-slate-600 px-4 py-2 focus:outline-none cursor-pointer rounded-l-full hover:bg-slate-50"><option value="baidu">百度</option><option value="jd">京东</option><option value="taobao">淘宝</option><option value="price">历史价</option></select><div class="w-px h-5 bg-slate-200"></div><input type="text" id="main-search" placeholder="搜索全网..." class="flex-1 px-4 text-sm bg-transparent border-none focus:outline-none" onkeydown="if(event.key==='Enter') doMainSearch()"><button onclick="doMainSearch()" class="w-10 h-10 bg-blue-600 rounded-full text-white hover:bg-blue-700 flex items-center justify-center shadow-md transition transform hover:scale-105"><i class="fas fa-arrow-right"></i></button></div>
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 font-bold text-slate-700 text-sm flex justify-between items-center"><span><i class="fas fa-chart-line text-yellow-500 mr-2"></i>国内金价实时行情 (来源: 上海黄金交易所)</span><span class="text-xs text-slate-400">实时更新</span></div>
                    <div class="p-0">
                        <table class="w-full market-table">
                            <thead>
                                <tr>
                                    <th class="w-1/6">品种名称</th>
                                    <th class="w-1/6">参考回收价</th>
                                    <th class="w-1/6">涨跌幅</th>
                                    <th class="w-1/6">最高价</th>
                                    <th class="w-1/6">最低价</th>
                                    <th class="w-1/6 text-right pr-6">时间</th>
                                </tr>
                            </thead>
                            <tbody id="table-gold-price">
                                <tr><td colspan="6" class="text-center text-slate-400 py-6">正在同步交易所数据...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div><h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">常用工具库</h3><div class="flex flex-wrap gap-3"><a href="https://next.itellyou.cn/" target="_blank" class="tool-btn"><i class="fab fa-windows text-blue-500"></i> MSDN 镜像</a><a href="https://www.drvceo.com/" target="_blank" class="tool-btn"><i class="fas fa-hdd text-slate-500"></i> 驱动总裁</a><a href="http://www.cmdpe.com/" target="_blank" class="tool-btn"><i class="fas fa-terminal text-slate-800"></i> CMDPE</a><a href="https://pc.qq.com/" target="_blank" class="tool-btn"><i class="fab fa-qq text-blue-400"></i> 腾讯软件</a><div class="w-px h-6 bg-slate-300 mx-1"></div><a href="https://chatgpt.com/" target="_blank" class="tool-btn"><i class="fas fa-robot text-green-500"></i> ChatGPT</a><a href="https://gemini.google.com/" target="_blank" class="tool-btn"><i class="fas fa-star text-blue-500"></i> Gemini</a><a href="https://www.doubao.com/" target="_blank" class="tool-btn"><i class="fas fa-comment-dots text-red-500"></i> 豆包 AI</a><div class="w-px h-6 bg-slate-300 mx-1"></div><a href="https://github.com/" target="_blank" class="tool-btn"><i class="fab fa-github text-slate-900"></i> GitHub</a></div></div>
                <div><div class="flex justify-between items-end mb-3"><h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">快捷入口</h3><button onclick="openLinkModal()" class="text-xs text-blue-500 hover:bg-blue-50 px-2 py-1 rounded"><i class="fas fa-plus mr-1"></i>添加</button></div><div id="nav-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="px-4 py-3 bg-slate-50 border-b border-slate-100 font-bold text-slate-700 text-sm flex justify-between items-center"><span><i class="fas fa-building text-blue-600 mr-2"></i>对公账户</span><span class="text-xs text-slate-400 cursor-pointer hover:text-blue-600" onclick="openConfigModal()">管理</span></div><div id="sec-corp" class="p-4 space-y-3"></div></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="px-4 py-3 bg-slate-50 border-b border-slate-100 font-bold text-slate-700 text-sm flex justify-between items-center"><span><i class="fas fa-user-shield text-yellow-600 mr-2"></i>对私账户</span><span class="text-xs text-slate-400 cursor-pointer hover:text-blue-600" onclick="openConfigModal()">管理</span></div><div id="sec-personal" class="p-4 space-y-3"></div></div></div>
            </div>
            
            <div id="page-documents" class="hidden space-y-8 max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative"><div class="absolute top-0 left-0 w-1 h-full bg-blue-500 rounded-l-xl"></div><h3 class="font-bold text-slate-800 text-lg mb-6 flex items-center"><i class="fas fa-file-contract text-blue-600 mr-3"></i>销售合同生成</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="space-y-4"><div><label class="text-xs font-bold text-slate-500 mb-1 block">乙方 (我方)</label><select id="party-b-select" class="clean-input"></select></div><div><label class="text-xs font-bold text-slate-500 mb-1 block">甲方 (客户)</label><input type="text" id="party-a-name" placeholder="客户全称" class="clean-input"></div></div><div class="space-y-4"><div><label class="text-xs font-bold text-slate-500 mb-1 block">甲方联系人</label><input type="text" id="party-a-contact" placeholder="姓名" class="clean-input"></div><div><label class="text-xs font-bold text-slate-500 mb-1 block">甲方电话</label><input type="text" id="party-a-phone" placeholder="电话" class="clean-input"></div></div></div><div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden mb-6"><div class="grid grid-cols-12 gap-2 bg-slate-100 border-b border-slate-200 text-[11px] text-slate-500 font-bold py-2 px-3"><div class="col-span-3">品名</div><div class="col-span-3 text-center">型号</div><div class="col-span-2 text-center">数量</div><div class="col-span-2 text-center">单价</div><div class="col-span-2 text-center"><button onclick="addProductRow()" class="text-blue-600 hover:text-blue-800">+ 添加</button></div></div><div id="product-rows" class="divide-y divide-slate-100"></div><div class="px-4 py-3 flex justify-between items-center text-sm font-bold bg-white"><span class="text-slate-500">大写：<span id="total-cn" class="text-slate-800">-</span></span><span class="text-blue-600">¥ <span id="total-num">0.00</span></span></div></div><button onclick="previewContract()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-200 transition"><i class="fas fa-eye mr-2"></i>生成合同预览</button></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative"><div class="absolute top-0 left-0 w-1 h-full bg-orange-500 rounded-l-xl"></div><h3 class="font-bold text-slate-800 text-lg mb-6 flex justify-between items-center"><span><i class="fas fa-receipt text-orange-500 mr-3"></i>便捷收据生成</span><button onclick="copyFromContract()" class="text-xs bg-orange-50 text-orange-600 px-3 py-1.5 rounded-full font-bold hover:bg-orange-100 transition"><i class="fas fa-arrow-down mr-1"></i>同步上方商品</button></h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4"><div><label class="text-xs font-bold text-slate-500 mb-1 block">销售方 (收款)</label><select id="rec-payee-select" class="clean-input"></select></div><div><label class="text-xs font-bold text-slate-500 mb-1 block">交款人 (付款)</label><input type="text" id="rec-payer" placeholder="客户姓名" class="clean-input"></div></div><div class="mb-4"><label class="text-xs font-bold text-slate-500 mb-2 block">收款方式</label><div class="flex gap-6 text-sm font-bold text-slate-600"><label class="flex items-center cursor-pointer hover:text-orange-600"><input type="radio" name="pay-method" value="微信" checked class="accent-orange-500 mr-2">微信</label><label class="flex items-center cursor-pointer hover:text-blue-600"><input type="radio" name="pay-method" value="支付宝" class="accent-blue-500 mr-2">支付宝</label><label class="flex items-center cursor-pointer hover:text-green-600"><input type="radio" name="pay-method" value="现金" class="accent-green-500 mr-2">现金</label><label class="flex items-center cursor-pointer hover:text-slate-800"><input type="radio" name="pay-method" value="银行转账" class="accent-slate-500 mr-2">转账</label></div></div><div class="mb-4"><label class="text-xs font-bold text-slate-500 mb-1 block">备注</label><input type="text" id="rec-remark" placeholder="例如：质保一年..." class="clean-input"></div><div class="bg-orange-50/30 rounded-lg border border-orange-100 overflow-hidden mb-6"><div class="grid grid-cols-12 gap-2 bg-orange-50 border-b border-orange-100 text-[11px] text-orange-800 font-bold py-2 px-3"><div class="col-span-5 text-left pl-2">收款项目</div><div class="col-span-2 text-center">数量</div><div class="col-span-3 text-center">金额</div><div class="col-span-2 text-center"><button onclick="addReceiptRow()" class="text-orange-600 hover:text-orange-800 font-bold">+ 添加</button></div></div><div id="receipt-rows" class="divide-y divide-orange-100"></div><div class="px-4 py-3 flex justify-between items-center text-sm font-bold bg-white"><span class="text-slate-500">合计</span><span class="text-orange-600">¥ <span id="rec-total-num">0.00</span></span></div></div><button onclick="previewReceipt()" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-lg shadow-orange-200 transition"><i class="fas fa-ticket-alt mr-2"></i>生成三联单预览</button></div></div>
            
            <div id="page-tools" class="hidden space-y-6 max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative group hover:border-yellow-400 transition">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-coins text-6xl text-yellow-500"></i></div>
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-yen-sign text-yellow-500 mr-2 bg-yellow-50 p-2 rounded-lg"></i>金额大写转换</h3>
                        <input type="number" oninput="convertRMB(this.value)" placeholder="输入金额..." class="w-full text-sm px-3 py-3 border rounded-lg focus:border-yellow-500 outline-none mb-4 bg-slate-50">
                        <p id="rmb-result" class="text-lg font-bold text-yellow-600 text-center py-3 bg-yellow-50 rounded-lg border border-yellow-100 dashed">零元整</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative group hover:border-blue-400 transition">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-qrcode text-6xl text-blue-500"></i></div>
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-expand text-blue-500 mr-2 bg-blue-50 p-2 rounded-lg"></i>二维码内容提取</h3>
                        <div class="relative w-full h-32 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center bg-slate-50 hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer">
                            <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="scanQR(this)">
                            <i class="fas fa-cloud-upload-alt text-2xl text-slate-400 mb-2"></i>
                            <span class="text-xs text-slate-500">点击上传二维码图片</span>
                        </div>
                        <div id="qr-result-box" class="hidden mt-3 p-2 bg-slate-100 rounded text-xs text-slate-600 break-all border border-slate-200"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-indigo-400 transition cursor-pointer" onclick="openTool('CPU 天梯图', 'https://tools.miku.ac/cpu_rank/')"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600"><i class="fas fa-microchip text-xl"></i></div><div><h3 class="font-bold text-slate-700">CPU 天梯图</h3><p class="text-xs text-slate-400 mt-1">处理器性能排行查询</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-purple-400 transition cursor-pointer" onclick="openTool('显卡天梯图', 'https://tools.miku.ac/gpu_rank/')"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600"><i class="fas fa-gamepad text-xl"></i></div><div><h3 class="font-bold text-slate-700">显卡天梯图</h3><p class="text-xs text-slate-400 mt-1">GPU 性能排行查询</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-green-400 transition cursor-pointer" onclick="openTool('实时汇率转换', 'https://tools.miku.ac/exchange_rate/')"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-green-600"><i class="fas fa-exchange-alt text-xl"></i></div><div><h3 class="font-bold text-slate-700">实时汇率转换</h3><p class="text-xs text-slate-400 mt-1">多国货币实时换算</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-pink-400 transition cursor-pointer" onclick="openTool('亲戚关系计算', 'https://tools.miku.ac/relatives_name/')"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center text-pink-600"><i class="fas fa-users text-xl"></i></div><div><h3 class="font-bold text-slate-700">亲戚关系转换</h3><p class="text-xs text-slate-400 mt-1">三姑六婆称呼计算器</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-cyan-400 transition cursor-pointer" onclick="openTool('号码归属查询', 'https://tools.miku.ac/mobile_tel_segment/')"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center text-cyan-600"><i class="fas fa-map-marker-alt text-xl"></i></div><div><h3 class="font-bold text-slate-700">号码归属查询</h3><p class="text-xs text-slate-400 mt-1">手机号段归属地查询</p></div></div></div>
                </div>
            </div>

            <div id="page-settings" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 flex"><button onclick="switchTab('corp')" id="tab-corp" class="px-6 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50">企业主体</button><button onclick="switchTab('personal')" id="tab-personal" class="px-6 py-3 text-sm font-bold text-slate-500 hover:text-slate-700">个人账户</button></div>
                    <div class="p-6">
                        <div id="view-corp" class="space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 border-dashed"><textarea id="smart-parse-text-corp" rows="3" class="w-full text-xs bg-transparent border-none outline-none resize-none placeholder-slate-400" placeholder="⚡ 粘贴发票信息，智能识别..."></textarea><button onclick="smartParse('corp')" class="w-full mt-2 py-1 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300 transition">一键智能识别填充</button></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input id="conf-name" type="text" placeholder="公司全称" class="clean-input"><input id="conf-abbr" type="text" placeholder="英文缩写" class="clean-input"><input id="conf-tax" type="text" placeholder="税号" class="clean-input"><input id="conf-bank" type="text" placeholder="开户行" class="clean-input"><input id="conf-account" type="text" placeholder="账号" class="clean-input"><input id="conf-address" type="text" placeholder="地址" class="clean-input"><input id="conf-contact" type="text" placeholder="联系人" class="clean-input"><input id="conf-phone" type="text" placeholder="电话" class="clean-input"></div>
                            <button onclick="saveEntity()" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">保存企业信息</button>
                            <div class="mt-4"><h4 class="text-xs font-bold text-slate-400 mb-2">已保存主体</h4><div id="entity-list-preview" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div></div>
                        </div>
                        <div id="view-personal" class="hidden space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 border-dashed"><textarea id="smart-parse-text-personal" rows="3" class="w-full text-xs bg-transparent border-none outline-none resize-none placeholder-slate-400" placeholder="⚡ 粘贴个人账号信息..."></textarea><button onclick="smartParse('personal')" class="w-full mt-2 py-1 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300 transition">一键智能识别填充</button></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="p-type" class="clean-input" onchange="togglePersonalFields()"><option value="bank">银行卡</option><option value="alipay">支付宝</option><option value="wechat">微信</option></select><input id="p-name" type="text" placeholder="姓名" class="clean-input"><div id="field-bank" class="contents"><input id="p-bank-name" type="text" placeholder="开户行" class="clean-input"><input id="p-account" type="text" placeholder="卡号" class="clean-input"></div><div id="field-qr" class="hidden col-span-2"><input type="file" id="p-qr-file" class="text-xs w-full"></div></div>
                            <button onclick="savePersonal()" class="w-full py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700">保存个人账户</button>
                            <div class="mt-4"><h4 class="text-xs font-bold text-slate-400 mb-2">已保存账户</h4><div id="personal-list-preview" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-3 bg-slate-50 border-b border-slate-100 font-bold text-slate-700 text-sm"><i class="fas fa-link text-blue-600 mr-2"></i>快捷入口管理</div>
                    <div class="p-6">
                        <div class="flex gap-4 mb-4">
                            <input id="new-link-name" type="text" placeholder="网站名称 (如: 百度)" class="clean-input flex-1">
                            <input id="new-link-url" type="text" placeholder="网址 (如: baidu.com)" class="clean-input flex-[2]">
                            <button onclick="saveNewLink()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">添加</button>
                        </div>
                        <div id="settings-link-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="tool-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex flex-col backdrop-blur-sm">
        <div class="h-12 bg-white flex justify-between items-center px-4 flex-shrink-0">
            <h3 class="font-bold text-slate-700" id="tool-modal-title">工具箱</h3>
            <div class="flex items-center gap-3">
                <a id="tool-new-tab" href="#" target="_blank" class="text-xs text-blue-500 hover:underline"><i class="fas fa-external-link-alt mr-1"></i>新窗口打开</a>
                <button onclick="document.getElementById('tool-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="flex-1 bg-white relative">
            <iframe id="tool-frame" class="w-full h-full border-none" src=""></iframe>
        </div>
    </div>

    <div id="preview-modal" class="hidden fixed inset-0 bg-black/70 z-[80] flex items-center justify-center backdrop-blur-md"><div class="bg-white rounded-2xl shadow-2xl w-[800px] max-h-[98vh] flex flex-col overflow-hidden"><div class="flex justify-between items-center p-4 border-b bg-slate-50 no-print"><h3 class="text-lg font-bold text-slate-800" id="preview-title">预览</h3><button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button></div><div id="print-area" class="flex-1 p-8 overflow-y-auto bg-white contract-font"></div><div class="p-4 border-t bg-slate-50 flex gap-3 no-print z-50"><button onclick="window.print()" class="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-700 transition flex items-center justify-center gap-2"><i class="fas fa-print"></i> 立即打印</button><button id="btn-export-word" onclick="exportToWord()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition hidden"><i class="fas fa-file-word mr-1"></i> 导出 Word</button></div></div></div>
    <div id="link-modal" class="hidden"></div><div id="config-modal" class="hidden"></div>
    <div id="qr-modal" class="hidden fixed inset-0 bg-black/80 z-[90] flex items-center justify-center backdrop-blur-sm" onclick="this.classList.add('hidden')"><img id="qr-display-img" src="" class="max-w-[300px] rounded-xl shadow-2xl"></div>
    <div id="profile-modal" class="hidden fixed inset-0 bg-black/50 z-[90] flex items-center justify-center backdrop-blur-sm" onclick="if(event.target===this) this.classList.add('hidden')"><div class="bg-white p-6 rounded-2xl shadow-xl w-80 transform transition-all"><h3 class="font-bold text-lg mb-4 text-slate-800 border-b pb-2">账户信息修改</h3><div class="space-y-3"><div><label class="text-[10px] text-slate-400 font-bold">公司名称</label><input id="up-company" type="text" class="clean-input"></div><div><label class="text-[10px] text-slate-400 font-bold">手机号</label><input id="up-phone" type="text" class="clean-input"></div><div><label class="text-[10px] text-slate-400 font-bold">新密码</label><input id="up-pass" type="password" class="clean-input"></div></div><div class="mt-4 flex justify-end gap-2"><button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="text-sm text-slate-500">取消</button><button onclick="updateProfile()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700">保存</button></div></div></div>

    <script>
        const API_BASE = '/api';
        const token = localStorage.getItem('zenflow_token');
        if(!token) window.location.href='login.html';
        
        let userInfo = {};
        try { userInfo = JSON.parse(localStorage.getItem('zenflow_user') || '{}'); } catch(e) {}
        
        const userDisplay = document.getElementById('sidebar-username');
        const avatarDisplay = document.getElementById('sidebar-avatar');
        if (userDisplay) userDisplay.innerText = userInfo.username || 'User';
        if (avatarDisplay) avatarDisplay.innerText = (userInfo.username||'U')[0].toUpperCase();

        let productList = [{name:'', spec:'', qty:1, price:0}];
        let receiptList = [{name:'', qty:1, price:0}]; 
        let myEntities=[], myPersonals=[], myLinks=[];

        async function authFetch(url, options={}){ options.headers = {...options.headers, 'Authorization':`Bearer ${token}`}; const res = await fetch(url, options); if(res.status===401){ localStorage.removeItem('zenflow_token'); window.location.href='login.html'; } return res.json(); }
        function safeSetText(id, text) { const el=document.getElementById(id); if(el) el.innerText=text; }
        let pinyin = (text) => []; try { if(window.pinyinPro && window.pinyinPro.pinyin) pinyin = window.pinyinPro.pinyin; } catch(e){}

        window.openLinkModal = function() { switchPage('settings'); document.getElementById('new-link-name').focus(); }
        window.openConfigModal = function() { switchPage('settings', document.querySelectorAll('.nav-item')[3]); }
        window.closeConfigModal = function() {} 
        window.closeLinkModal = function() {} 
        window.openProfileModal = function(){ document.getElementById('up-company').value=userInfo.company||''; document.getElementById('up-phone').value=userInfo.phone||''; document.getElementById('profile-modal').classList.remove('hidden'); }
        window.toggleUserMenu = function(e){ e.stopPropagation(); document.getElementById('user-dropdown').classList.toggle('hidden'); }
        window.doLogout = function(){ localStorage.clear(); window.location.href='login.html'; }
        window.toggleSection = function(id) { document.getElementById(id).classList.toggle('hidden'); document.getElementById('icon-'+id).classList.toggle('rotate-90'); }
        window.switchTab = function(t){ document.getElementById('view-corp').classList.toggle('hidden',t!=='corp'); document.getElementById('view-personal').classList.toggle('hidden',t!=='personal'); const activeClass='bg-blue-50 border-b-2 border-blue-600 text-blue-600'; const inactiveClass='text-slate-500 hover:text-slate-700'; document.getElementById('tab-corp').className=t==='corp'?`px-6 py-3 text-sm font-bold ${activeClass}`:`px-6 py-3 text-sm font-bold ${inactiveClass}`; document.getElementById('tab-personal').className=t==='personal'?`px-6 py-3 text-sm font-bold ${activeClass}`:`px-6 py-3 text-sm font-bold ${inactiveClass}`; }
        window.togglePersonalFields = function(){const t=document.getElementById('p-type').value;document.getElementById('field-bank').classList.toggle('hidden',t!=='bank');document.getElementById('field-qr').classList.toggle('hidden',t==='bank');}
        window.switchPage = function(pageId, btn) { ['workbench', 'documents', 'tools', 'settings'].forEach(p => document.getElementById(`page-${p}`).classList.add('hidden')); document.getElementById(`page-${pageId}`).classList.remove('hidden'); const titles = {workbench:'工作台', documents:'单据中心', tools:'转换工厂', settings:'配置中心'}; document.getElementById('page-title').innerText = titles[pageId]; document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-white', 'bg-white/10', 'border-l-4', 'border-yellow-400')); if(btn) btn.classList.add('active'); if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden'); if(pageId==='workbench') setTimeout(fetchGoldPrice, 500); }
        window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('hidden'); }
        window.doMainSearch = function(){const k=document.getElementById('main-search').value, t=document.getElementById('engine-select').value; if(k)window.open(t==='price'?`http://s.manmanbuy.com/Default.aspx?key=${k}`:`https://www.baidu.com/s?wd=${k}`,'_blank');}
        window.convertRMB = function(n){ safeSetText('rmb-result', convertCurrency(n)); }
        
        window.openTool = function(title, url) {
            document.getElementById('tool-modal-title').innerText = title;
            document.getElementById('tool-frame').src = url;
            document.getElementById('tool-new-tab').href = url;
            document.getElementById('tool-modal').classList.remove('hidden');
        }
        
        window.scanQR = function(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0, img.width, img.height);
                    const imageData = context.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    const box = document.getElementById('qr-result-box');
                    if (code) {
                        box.innerHTML = `<span class="font-bold text-green-600">识别成功：</span> ${code.data} <button class="ml-2 text-blue-500 underline" onclick="copyText('${code.data}')">复制</button>`;
                        box.classList.remove('hidden');
                    } else {
                        box.innerHTML = '<span class="text-red-500">无法识别二维码，请确保图片清晰</span>';
                        box.classList.remove('hidden');
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function genShort() { alert("功能已下线"); }
        window.showQR = function(s){ if(!s)return alert("未上传"); document.getElementById('qr-display-img').src=s.replace('http://localhost:3000',''); document.getElementById('qr-modal').classList.remove('hidden'); }
        function convertCurrency(n) { if(!n) return '零元整'; const d=['零','壹','贰','叁','肆','伍','陆','柒','捌','玖'];const u=[['元','万','亿'],['','拾','佰','仟']];let s=''; n=Math.abs(n);for(let i=0;i<u[0].length&&n>0;i++){let p='';for(let j=0;j<u[1].length&&n>0;j++){p=d[n%10]+u[1][j]+p;n=Math.floor(n/10);}s=p.replace(/(零.)*零$/,'').replace(/^$/,'零')+u[0][i]+s;} return s.replace(/(零.)*零元/,'元').replace(/(零.)+/g,'零').replace(/^整$/,'零元整')+"整"; }
        function copyText(t){navigator.clipboard.writeText(t).then(()=>alert('已复制'));}

        function addProductRow() { productList.push({name:'', spec:'', qty:1, price:0}); renderProducts(); }
        function removeProductRow(i) { if(productList.length>1){productList.splice(i,1);renderProducts();} }
        function updateProduct(i, f, v) { productList[i][f]=v; calculateTotal(); }
        function renderProducts() { const el = document.getElementById('product-rows'); if(el) el.innerHTML = productList.map((p, i) => `<div class="grid grid-cols-12 gap-2 items-center py-1 px-3 hover:bg-slate-50 transition"><div class="col-span-3"><input type="text" value="${p.name}" oninput="updateProduct(${i},'name',this.value)" class="clean-input text-left" placeholder="品名"></div><div class="col-span-3"><input type="text" value="${p.spec}" oninput="updateProduct(${i},'spec',this.value)" class="clean-input text-center" placeholder="型号"></div><div class="col-span-2"><input type="number" value="${p.qty}" oninput="updateProduct(${i},'qty',this.value)" class="clean-input text-center"></div><div class="col-span-2"><input type="number" value="${p.price}" oninput="updateProduct(${i},'price',this.value)" class="clean-input text-center"></div><div class="col-span-2 flex justify-center text-xs">${productList.length>1 ? `<button onclick="removeProductRow(${i})" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>` : `-`}</div></div>`).join(''); calculateTotal(); }
        function calculateTotal() { let t=0; productList.forEach(p=>{t+=(p.qty||0)*(p.price||0)}); safeSetText('total-num', t.toFixed(2)); safeSetText('total-cn', convertCurrency(t)); }
        
        function addReceiptRow() { receiptList.push({name:'', qty:1, price:0}); renderReceipts(); }
        function removeReceiptRow(i) { if(receiptList.length>1){receiptList.splice(i,1);renderReceipts();} }
        function updateReceipt(i, f, v) { receiptList[i][f]=v; calcReceiptTotal(); }
        function renderReceipts() { const el = document.getElementById('receipt-rows'); if(el) el.innerHTML = receiptList.map((p, i) => `<div class="grid grid-cols-12 gap-2 items-center py-1 px-3 hover:bg-orange-50 transition text-[11px]"><div class="col-span-5"><input type="text" value="${p.name}" oninput="updateReceipt(${i},'name',this.value)" class="clean-input text-left" placeholder="品名"></div><div class="col-span-2"><input type="number" value="${p.qty}" oninput="updateReceipt(${i},'qty',this.value)" class="clean-input text-center"></div><div class="col-span-3"><input type="number" value="${p.price}" oninput="updateReceipt(${i},'price',this.value)" class="clean-input text-center"></div><div class="col-span-2 flex justify-center text-xs">${receiptList.length>1 ? `<button onclick="removeReceiptRow(${i})" class="text-orange-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : `-`}</div></div>`).join(''); calcReceiptTotal(); }
        function calcReceiptTotal() { let t=0; receiptList.forEach(p=>{t+=(p.qty||0)*(p.price||0)}); safeSetText('rec-total-num', t.toFixed(2)); }
        function copyFromContract() { receiptList = productList.map(p => ({name: p.name + (p.spec?` (${p.spec})`:''), qty: p.qty, price: p.price})); renderReceipts(); }

        function previewReceipt() {
            const rawVal = document.getElementById('rec-payee-select').value;
            if(!rawVal) return alert("请选择销售方");
            const [type, id] = rawVal.split('_');
            let payee = type === 'corp' ? myEntities.find(e => e.id == id) : myPersonals.find(p => p.id == id);
            const payer = document.getElementById('rec-payer').value;
            const remark = document.getElementById('rec-remark').value || '无'; 
            if (!payee || !payer) return alert("请填写收付款人信息");
            
            const method = document.querySelector('input[name="pay-method"]:checked').value;
            const today = new Date();
            const dateStr = `${today.getFullYear()}年${String(today.getMonth()+1).padStart(2,'0')}月${String(today.getDate()).padStart(2,'0')}日`;
            const contractNo = `${payee.abbr||'ZG'}${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}${String(Math.floor(Math.random() * 999)).padStart(3, '0')}`;
            let total = 0; receiptList.forEach(p=>{total+=(p.qty||0)*(p.price||0)});
            const totalCn = convertCurrency(total);
            document.getElementById('btn-export-word').classList.add('hidden');
            document.getElementById('preview-title').innerHTML = '<i class="fas fa-receipt text-orange-600 mr-2"></i>三联单收据预览';
            let sealHtml = payee.bank ? `<div class="seal-corp"><div class="seal-corp-name">${payee.name}</div><div class="seal-corp-type">财务专用章</div></div>` : `<div class="seal-person">${payee.name}<br>之印</div>`;
            const renderReceiptPart = (联名, 背景) => `<div class="receipt-item p-6 mb-8 rounded shadow-sm relative border border-gray-200" style="background-color: ${背景};"><div class="absolute top-4 right-4 text-[10px] font-bold opacity-30">${联名}</div><h1 class="text-2xl font-bold text-center tracking-[0.5em] mb-2 font-serif">收款收据</h1><div class="flex justify-between text-[10px] mb-2"><span>No. <span class="font-bold contract-num">${contractNo}</span></span><span>日期：${dateStr}</span></div><table class="w-full border-collapse border border-black text-xs"><tr><td class="border border-black p-2 bg-white/50 w-24">交款单位</td><td class="border border-black p-2 font-bold bg-white" colspan="3">${payer}</td></tr><tr><td class="border border-black p-2 bg-white/50">收款方式</td><td class="border border-black p-2 bg-white" colspan="3"><span>${method === '微信' ? '☑' : '☐'} 微信</span><span class="ml-4">${method === '支付宝' ? '☑' : '☐'} 支付宝</span><span class="ml-4">${method === '现金' ? '☑' : '☐'} 现金</span><span class="ml-4">${method === '银行转账' ? '☑' : '☐'} 转账</span></td></tr><tr><td class="border border-black p-2 bg-white/50 text-center">收款内容</td><td class="border border-black p-2 bg-white/50 text-center w-16">数量</td><td class="border border-black p-2 bg-white/50 text-center w-24">单价</td><td class="border border-black p-2 bg-white/50 text-center w-32">金额</td></tr>${receiptList.map(p => `<tr><td class="border border-black p-1 bg-white text-center">${p.name}</td><td class="border border-black p-1 text-center bg-white">${p.qty}</td><td class="border border-black p-1 text-center bg-white">${parseFloat(p.price).toFixed(2)}</td><td class="border border-black p-1 text-center bg-white font-bold">${(p.qty*p.price).toFixed(2)}</td></tr>`).join('')}<tr><td class="border border-black p-2 bg-white/50">合计(大写)</td><td class="border border-black p-2 font-bold bg-white" colspan="3"><div class="flex justify-between"><span>${totalCn}</span><span>小写：¥ ${total.toFixed(2)}</span></div></td></tr><tr><td class="border border-black p-2 bg-white/50">备注</td><td class="border border-black p-2 bg-white" colspan="3">${remark}</td></tr></table><div class="flex justify-between mt-4 px-2 text-[11px] relative"><div>销售方：<span class="font-bold">${payee.name}</span></div><div class="absolute right-32 -top-10 opacity-80">${sealHtml}</div><div>收款人：<span class="font-bold">${userInfo.username||'经办人'}</span></div></div></div>`;
            document.getElementById('print-area').innerHTML = `<div>${renderReceiptPart('第一联：存根(白)','#fff')}${renderReceiptPart('第二联：客户(红)','#fff5f5')}${renderReceiptPart('第三联：记账(黄)','#fffdf0')}</div>`;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function previewContract() {
            const bId = document.getElementById('party-b-select').value;
            const partyB = myEntities.find(e => e.id == bId);
            const partyA = document.getElementById('party-a-name').value;
            if (!partyB || !partyA) return alert("请完善合同双方信息");
            const today = new Date();
            const dateStr = `${today.getFullYear()}年${String(today.getMonth()+1).padStart(2,'0')}月${String(today.getDate()).padStart(2,'0')}日`;
            const contractNo = `${partyB.abbr||'ZG'}${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}${String(Math.floor(Math.random() * 999)).padStart(3, '0')}`;
            let total = 0; productList.forEach(p=>{total+=(p.qty||0)*(p.price||0)});
            document.getElementById('btn-export-word').classList.remove('hidden');
            document.getElementById('preview-title').innerHTML = '<i class="fas fa-file-contract text-blue-600 mr-2"></i>合同预览';
            safeSetText('v-no', contractNo); safeSetText('v-date', dateStr); safeSetText('v-total', '¥ ' + total.toFixed(2)); safeSetText('v-total-cn', convertCurrency(total));
            const bankInfo = `<div class="bank-info-box"><div>户名：${partyB.name}</div><div>开户行：${partyB.bank || '未设置'}</div><div>账号：<b>${partyB.account || '未设置'}</b></div></div>`;
            
            const html = `
                <div style="text-align: center; margin-bottom: 20px;"><h1 style="font-size: 24pt; font-weight: bold; border-bottom: 2px solid black; display: inline-block;">销售合同</h1></div>
                <table style="width: 100%; border: none; margin-bottom: 10px; font-size: 10pt;"><tr><td style="border: none; text-align: left;">合同编号：<span class="contract-num">${contractNo}</span></td><td style="border: none; text-align: right;">日期：${dateStr}</td></tr></table>
                <table style="width: 100%; border: none; margin-bottom: 15px; font-size: 10pt;">
                    <tr>
                        <td style="width: 50%; vertical-align: top; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;"><div><b>甲方：${partyA}</b></div><div>联系：${(document.getElementById('party-a-contact').value||'')+(document.getElementById('party-a-phone').value||'')}</div></td>
                        <td style="width: 50%; vertical-align: top; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;"><div><b>乙方：${partyB.name}</b></div><div>联系：${(partyB.contact||'')+(partyB.phone||'')}</div></td>
                    </tr>
                </table>
                <div class="text-xs indent-8 mb-3">甲乙双方本着平等互利原则，协商一致签订此合同：</div>
                <div class="section-title">一、产品明细</div>
                <table class="contract-table" style="width: 100%; border-collapse: collapse; border: 1px solid black; margin-bottom: 15px; font-size: 10pt;">
                    <thead style="background: #f2f2f2; font-weight: bold;">
                        <tr><th style="border: 1px solid black; padding: 5px; text-align: center;">品名</th><th style="border: 1px solid black; padding: 5px; text-align: center;">规格</th><th style="border: 1px solid black; padding: 5px; text-align: center;">数量</th><th style="border: 1px solid black; padding: 5px; text-align: center;">单价</th><th style="border: 1px solid black; padding: 5px; text-align: center;">合计</th></tr>
                    </thead>
                    <tbody>
                        ${productList.map(p=>`<tr><td style="border: 1px solid black; padding: 5px; text-align: center;">${p.name}</td><td style="border: 1px solid black; padding: 5px; text-align: center;">${p.spec}</td><td style="border: 1px solid black; padding: 5px; text-align: center;">${p.qty}</td><td style="border: 1px solid black; padding: 5px; text-align: right; font-weight: bold;">${parseFloat(p.price).toFixed(2)}</td><td style="border: 1px solid black; padding: 5px; text-align: right; font-weight: bold;">${(p.qty*p.price).toFixed(2)}</td></tr>`).join('')}
                        <tr><td colspan="2" style="border: 1px solid black; padding: 5px; text-align: center;">合计</td><td colspan="3" style="border: 1px solid black; padding: 5px; text-align: right; font-weight: bold;">${total.toFixed(2)}</td></tr>
                        <tr><td colspan="2" style="border: 1px solid black; padding: 5px; text-align: center;">大写</td><td colspan="3" style="border: 1px solid black; padding: 5px; text-align: left;">${convertCurrency(total)}</td></tr>
                    </tbody>
                </table>
                <div class="term-block">
                    <div class="term-title">二、交货方式及费用：</div><div class="term-content">合同签订生效后，甲方支付全部合同价款后，乙方开始订货，乙方不承担物流公司导致的延迟交付责任。甲方未依照本合同约定支付合同价款的，乙方有权拒绝交付合同标的物且不承担违约责任。运费及保险费用都由甲方承担。<strong>指定收货方式及收货人信息：客户指定收货地址。</strong></div>
                    <div class="term-title">三、货物验收：</div><div class="term-content">自乙方交付本合同标的物之日起3日内，如甲方未对乙方交付的产品、质量、数量、包装等向乙方提出书面异议，视为甲方验收合格。</div>
                    <div class="term-title">四、付款时间和付款方式：</div><div class="term-content">款到发货，本合同的有效期至甲方将所有货款全部付清时终止。除非乙方特别说明和指定，甲方向非本合同约定的乙方账户支付任何款项，乙方都不予认可，由此产生的一切责任由甲方承担。乙方账户信息如下：${bankInfo}</div>
                    <div class="term-title">五、违约责任：</div><div class="term-content">甲方逾期支付合同价款的，应按合同总价款3‰/日的标准向乙方支付违约金。逾期支付超过30日的，乙方有权解除本合同，甲方除支付前述逾期付款违约金外，还应按本合同总价款20％的标准向乙方支付违约金，且甲方已支付的预付款不予退还。同时，由甲方承担乙方为主张债权所产生的全部费用（包括但不限于：律师代理费、交通费、住宿费等）。如甲方将本合同标的物用于违反产品制造方合规政策要求的用途，导致乙方遭受直接或间接损失的，甲方应承担全部赔偿责任。</div>
                    <div class="term-title">六、担保责任：</div><div class="term-content">甲方委托的本合同经办人、签收人及自提人应作为担保方对甲方拖欠货款形成的上述全部债务及违约责任承担连带保证责任。担保期限：自甲方付款期限到期之日起两年。</div>
                    <div class="term-title">七、诉讼管辖：</div><div class="term-content">因本合同履行所引起的纠纷，由乙方所在地人民法院管辖。</div>
                    <div class="term-title">八、合同签订形式：</div><div class="term-content">甲乙双方同意本合同可以通过互发传真、邮件、图片等电子数据形式成立。电子数据与合同原件具有同等法律效力，甲方在签署本合同后应及时回传给乙方，乙方收到甲方回传的合同后，本合同生效。</div>
                    <div class="term-title">九、特别说明：</div><div class="term-content">各方确定本合同所列地址为各自有效地址，其中一方变更应及时书面通知另一方。若一方地址有误，致使另一方无法送达，由过错方承担全部责任（一方以确定的地址发送，被退回之日视为送达）。</div>
                </div>
                <table style="width: 100%; border: none; margin-top: 30px; font-size: 11pt;"><tr><td style="width: 50%; vertical-align: top; border: none; padding-right: 20px;"><b>甲方（盖章）：</b><br><br><br>签字：_________________</td><td style="width: 50%; vertical-align: top; border: none; padding-left: 20px;"><b>乙方（盖章）：</b><br><br><br>签字：_________________</td></tr></table>`;
            document.getElementById('print-area').innerHTML = html;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        window.exportToWord = function() { 
            try { 
                const bSelect=document.getElementById('party-b-select'); 
                if(!bSelect||!bSelect.value) return alert("请先选择乙方"); 
                const partyA=document.getElementById('party-a-name').value||'客户'; 
                
                const htmlContent = document.getElementById('print-area').innerHTML;
                
                const wordHTML = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset="utf-8"><title>Export</title><style>body { font-family: "SimSun", "Songti SC", serif; font-size: 10.5pt; } h1 { text-align: center; font-size: 22pt; font-weight: bold; } table { border-collapse: collapse; width: 100%; } td, th { border: 1px solid black; padding: 5px; } .contract-table td, .contract-table th { text-align: center; vertical-align: middle; } .term-title { font-weight: bold; margin-top: 10pt; } .bank-info-box { border: 1px dashed #333; padding: 5px; background: #f9f9f9; }</style></head><body>${htmlContent}</body></html>`;
                
                const blob=new Blob([wordHTML],{type:'application/msword'}); 
                const url=URL.createObjectURL(blob); 
                const link=document.createElement('a'); 
                link.href=url; link.download=`销售合同_${partyA}.doc`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } catch(e){ alert("导出失败: "+e.message); } 
        }

        window.smartParse = function(type) { const text = document.getElementById(type==='corp' ? 'smart-parse-text-corp' : 'smart-parse-text-personal').value; if(!text) return alert("请先粘贴信息"); const rules = { name: /(?:名称|单位|户名|姓名|企业名称|账户名)[:：]?\s*([^\n\s]+)/, tax: /(?:税号|信用代码|统一社会信用代码)[:：]?\s*([A-Z0-9]{15,20})/, bank: /(?:开户行|银行|开户银行)[:：]?\s*([^\n\s\d]+)/, account: /(?:账号|账户|帐号|卡号)[:：]?\s*(\d[\d\s-]{8,})/, address: /(?:地址|企业地址)[:：]?\s*([^\n]+)/, phone: /(?:电话|手机|联系)[:：]?\s*([\d-]{8,})/ }; const extract = (key) => { const m = text.match(rules[key]); return m ? m[1].trim() : ''; }; if (type === 'corp') { document.getElementById('conf-name').value = extract('name'); document.getElementById('conf-tax').value = extract('tax'); document.getElementById('conf-bank').value = extract('bank'); document.getElementById('conf-account').value = extract('account'); document.getElementById('conf-address').value = extract('address'); document.getElementById('conf-phone').value = extract('phone'); try { const name = extract('name'); if(name) document.getElementById('conf-abbr').value = pinyin(name, {pattern:'first', toneType:'none', type:'array'}).join('').toUpperCase(); } catch(e){} } else { document.getElementById('p-name').value = extract('name'); document.getElementById('p-bank-name').value = extract('bank'); document.getElementById('p-account').value = extract('account'); const bankVal = extract('bank'); document.getElementById('p-type').value = bankVal ? 'bank' : 'alipay'; togglePersonalFields(); } alert("识别完成，请核对信息！"); }
        window.saveEntity = async function(){ const d={name:document.getElementById('conf-name').value, abbr:document.getElementById('conf-abbr').value||'CODE', tax:document.getElementById('conf-tax').value, address:document.getElementById('conf-address').value, contact:document.getElementById('conf-contact').value, phone:document.getElementById('conf-phone').value, bank:document.getElementById('conf-bank').value, account:document.getElementById('conf-account').value}; if(!d.name)return alert("名称必填"); await authFetch(`${API_BASE}/company/save`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); renderAll(); alert('保存成功'); }
        window.removeEntity = async function(id){ if(confirm('删?')){ await authFetch(`${API_BASE}/company/delete`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); renderAll(); } }
        
        // 🚀 核心修复：上传图片逻辑 + 保存数据
        window.savePersonal = async function(){ 
            const t = document.getElementById('p-type').value; 
            const n = document.getElementById('p-name').value; 
            if(!n) return alert("姓名必填"); 
            
            let qrUrl = '';
            // 如果不是银行卡，尝试上传图片
            if (t !== 'bank') {
                const fileInput = document.getElementById('p-qr-file');
                if (fileInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    try {
                        const upRes = await fetch(`${API_BASE}/upload`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }, // 不设置Content-Type，让浏览器自适应multipart
                            body: formData
                        });
                        const upData = await upRes.json();
                        if (upData.url) qrUrl = upData.url;
                    } catch(e) {
                        console.error("上传失败", e);
                        return alert("二维码图片上传失败，请重试");
                    }
                }
            }

            const d = {
                type: t, 
                name: n, 
                bank: document.getElementById('p-bank-name').value, 
                account: document.getElementById('p-account').value, 
                qr_url: qrUrl
            }; 
            
            await authFetch(`${API_BASE}/personal/save`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); 
            renderAll(); 
            alert('保存成功'); 
        }
        
        window.removePersonal = async function(id){ if(confirm('删?')){ await authFetch(`${API_BASE}/personal/delete`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); renderAll(); } }
        
        window.saveNewLink = async function(){const n=document.getElementById('new-link-name').value, u=document.getElementById('new-link-url').value; if(!n||!u)return; await authFetch(`${API_BASE}/link/save`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, url:u.startsWith('http')?u:'https://'+u})}); renderAll(); document.getElementById('new-link-name').value=''; document.getElementById('new-link-url').value=''; }
        window.removeLink = async function(id){ await authFetch(`${API_BASE}/link/delete`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); renderAll(); }
        window.updateProfile = async function(){ const c=document.getElementById('up-company').value, p=document.getElementById('up-phone').value, pwd=document.getElementById('up-pass').value; await authFetch(`${API_BASE}/user/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({company_name:c, phone:p, password:pwd})}); alert('修改成功'); userInfo.company=c; userInfo.phone=p; localStorage.setItem('zenflow_user', JSON.stringify(userInfo)); document.getElementById('profile-modal').classList.add('hidden'); }
        
        async function renderAll() {
            try {
                const r1 = await authFetch(`${API_BASE}/company/list`); myEntities=r1.data||[];
                const r2 = await authFetch(`${API_BASE}/personal/list`); myPersonals=r2.data||[];
                const r3 = await authFetch(`${API_BASE}/link/list`); myLinks=r3.data||[];
                const bSel = document.getElementById('party-b-select'); if(bSel) bSel.innerHTML = myEntities.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                const recSel = document.getElementById('rec-payee-select'); if(recSel) { let ops = '<optgroup label="企业">'; ops += myEntities.map(e => `<option value="corp_${e.id}">${e.name}</option>`).join(''); ops += '</optgroup><optgroup label="个人">'; ops += myPersonals.map(p => `<option value="personal_${p.id}">${p.name}</option>`).join(''); ops += '</optgroup>'; recSel.innerHTML = ops; }
                document.getElementById('sec-corp').innerHTML = myEntities.map(e => `<div class="p-3 bg-blue-50 border border-blue-100 rounded hover:bg-blue-100 transition cursor-pointer relative" onclick="copyText('名称：${e.name}\\n税号：${e.tax}\\n账号：${e.account}\\n开户行：${e.bank}')"><p class="text-xs font-bold text-blue-800 mb-1 truncate">${e.name}</p><p class="text-[10px] text-blue-600 font-mono">税号：${e.tax||'未录入'}</p><p class="text-[10px] text-blue-600 font-mono">账号：${e.account}</p></div>`).join('');
                
                // 🚀 核心修复：渲染时判断是否有二维码
                document.getElementById('sec-personal').innerHTML = myPersonals.map(p => { 
                    let info = p.type; 
                    let clickAction = '';
                    
                    if(p.type==='bank') {
                        info = `${p.bank} <span class="font-mono text-[9px] text-slate-400">(${p.account.slice(-4)})</span>`; 
                        clickAction = `copyText('户名：${p.name}\\n账号：${p.account}\\n开户行：${p.bank}')`;
                    } else if(p.type==='alipay') {
                        info = '<span class="text-blue-500">支付宝</span>'; 
                        // 有码显示码，无码复制
                        if(p.qr_url && p.qr_url.length > 5) clickAction = `showQR('${p.qr_url}')`;
                        else clickAction = `copyText('姓名：${p.name}\\n类型：${p.type}\\n账号：${p.account}')`;
                    } else if(p.type==='wechat') {
                        info = '<span class="text-green-500">微信</span>'; 
                        // 有码显示码，无码复制
                        if(p.qr_url && p.qr_url.length > 5) clickAction = `showQR('${p.qr_url}')`;
                        else clickAction = `copyText('姓名：${p.name}\\n类型：${p.type}\\n账号：${p.account}')`;
                    }
                    
                    return `<div class="p-3 bg-orange-50 border border-orange-100 rounded hover:bg-orange-100 cursor-pointer" onclick="${clickAction}"><p class="text-xs font-bold text-orange-800 mb-1 truncate">${p.name}</p><p class="text-[10px] text-orange-600 font-bold">${info}</p></div>`; 
                }).join('');
                
                document.getElementById('nav-grid').innerHTML = myLinks.map(l=>`<div class="group bg-white p-3 rounded-xl flex flex-col items-center justify-center border hover:border-blue-300 cursor-pointer relative" onclick="window.open('${l.url}','_blank')"><button onclick="event.stopPropagation();removeLink(${l.id});" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[8px] hidden group-hover:flex items-center justify-center">×</button><span class="text-xs font-bold text-blue-600 bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full mb-1">${l.name[0]}</span><span class="text-[10px] text-slate-600 truncate w-full text-center">${l.name}</span></div>`).join('');
                document.getElementById('entity-list-preview').innerHTML = myEntities.map(e => `<div class="flex justify-between items-center text-xs bg-slate-50 p-2 rounded"><span>${e.name}</span><button onclick="removeEntity(${e.id})" class="text-red-400">删</button></div>`).join('');
                document.getElementById('personal-list-preview').innerHTML = myPersonals.map(p => { let info = p.type; if(p.type==='bank') info = p.bank; return `<div class="flex justify-between items-center text-xs bg-slate-50 p-2 rounded"><span>${p.name} - ${info}</span><button onclick="removePersonal(${p.id})" class="text-red-400">删</button></div>`; }).join('');
                document.getElementById('settings-link-list').innerHTML = myLinks.map(l => `<div class="flex justify-between items-center text-xs bg-slate-50 p-2 rounded"><span>${l.name} - ${l.url}</span><button onclick="removeLink(${l.id})" class="text-red-400">删</button></div>`).join('');
            } catch(e) { console.error(e); }
        }

        // ✅ 黄金行情: 移除提示语，直接显示扣减后价格
        async function fetchGoldPrice() { 
            try { 
                const res = await authFetch(`${API_BASE}/tools/gold-price`); 
                const html = (res.data || []).map(m => { 
                    let rawPrice = parseFloat(m.price); 
                    let adjust = 0; 
                    if (m.name.includes('黄金') || m.name.includes('Au') || m.name.includes('100g')) adjust = -7; 
                    else if (m.name.includes('铂金') || m.name.includes('PT')) adjust = -10; 
                    else if (m.name.includes('白银')) adjust = -0.15; 
                    const finalPrice = (rawPrice + adjust).toFixed(2); 
                    
                    const val = parseFloat(m.change.replace('%','')); 
                    const color = val > 0 ? 'text-red-500 font-bold' : (val < 0 ? 'text-green-600 font-bold' : 'text-slate-500'); 
                    return `<tr class="hover:bg-slate-50 transition"><td>${m.name}</td><td class="${color}">${finalPrice}</td><td class="${color}">${val>0?'↑':(val<0?'↓':'')} ${m.change}</td><td class="text-slate-500">${m.max}</td><td class="text-slate-500">${m.min}</td><td class="text-right pr-6 text-xs text-slate-400 font-mono">${m.time}</td></tr>`; 
                }).join('') || '<tr><td colspan="6" class="text-center text-slate-400 py-6">暂无数据</td></tr>'; 
                document.getElementById('table-gold-price').innerHTML = html; 
            } catch(e) { 
                document.getElementById('table-gold-price').innerHTML = '<tr><td colspan="6" class="text-center text-red-400 py-6">行情加载失败，请检查网络</td></tr>'; 
            } 
        }

        // Init
        renderReceipts(); 
        renderProducts();
        renderAll();
        setTimeout(fetchGoldPrice, 500); 
        document.addEventListener('click', () => { const el = document.getElementById('user-dropdown'); if(el) el.classList.add('hidden'); });
    </script>
</body>
</html>
